// ImgToText ESM - v1.1.0
import{CDEUtils,FPSCounter,CanvasUtils,Color,_HasColor,GridAssets,TypingDevice,Mouse,Render,TextStyles,RenderStyles,Canvas,Anim,_BaseObj,AudioDisplay,ImageDisplay,TextDisplay,_DynamicColor,Pattern,_Obj,Shape,Gradient,FilledShape,Grid,Dot}from"cdejs";export class ImageToTextConverter{static DEFAULT_CHARACTER_SETS={VERY_LOW:[" ",".",":"],VERY_LOW_REVERSED:[":","."," "],LOW:[" ",".",":","-","~","=","+","o","O","X","H","M"],LOW_LARGE:["  "," ."," :"," -"," ~"," ="," +"," o"," O"," X"," H"," M"],LOW_REVERSED:["M","H","X","O","o","+","=","~","-",":","."," "],MIDDLE:[" ",".",":","-","~","=","+","o","O","X","H","M","B","8","$","W","%","@","#"],MIDDLE_REVERSED:["#","@","%","W","$","8","B","M","H","X","O","o","+","=","~","-",":","."," "],MIDDLE_PATCHY:[" ",".",":","-","~","=","+","o","O","X","H","M","B","8","$","W","%","@","#","¦","¦","¦","¦"],MIDDLE_PATCHY_REVERSED:["¦","¦","¦","¦","#","@","%","W","$","8","B","M","H","X","O","o","+","=","~","-",":","."," "],HIGH:[" ",".",",","-","~","=",":",";","+","c","o","O","X","H","M","B","$","?","#","@","¦","¦","¦","¦"],HIGH_REVERSED:["¦","¦","¦","¦","@","#","?","$","B","M","H","X","O","o","c","+",";",":","=","~","-",",","."," "],HIGH_CENTRAL_SHADING:[,"¦","¦","¦","@","#","?","$","B","M","H","X","O","o","c","+",";",":","=","~","-",",","."," ",".",",","-","~","=",":",";","+","c","o","O","X","H","M","B","$","?","#","@","¦","¦","¦","¦"],HIGH_OUTER_SHADING:[" ",".",",","-","~","=",":",";","+","c","o","O","X","H","M","B","$","?","#","@","¦","¦","¦","¦","¦","¦","¦","@","#","?","$","B","M","H","X","O","o","c","+",";",":","=","~","-",",","."," "],ASCII:[" ","¦","¦","¦","¦"],ASCII_REVERSED:["¦","¦","¦","¦"," "],BRIGHT_ASCII:["¦","¦","¦","¦"],BRIGHT_ASCII_REVERSED:["¦","¦","¦","¦"],LINES:[" ","-","?","-","¦","¦","?","+","+","?","¦"],LINES_REVERSED:["¦","?","+","+","?","¦","¦","-","?","-"," "],LINE_SEMI_CENTRAL_SHADING:[" ","-","?","¦","?","+","?","-","¦","+","¦"],BINARY:[" ","1","0"],BINARY_REVERSED:["0","1"," "],BINARY_EXPANDED:[" ",".","¹","°","1","0"],BINARY_EXPANDED_REVERSED:["0","1","°","¹","."," "],DOTS:[" ",".","·","'",":"],SIMPLE:[" ",".",":","-","~","=","?","#"],SYMBOLS:[" ",".","*","+","8","%","#","&","§","?","@","¦"],WAVY_BOXES:[" ",".",":","=","=","?","?","?","¦"]};static DEFAULT_CHARACTER_SET=ImageToTextConverter.DEFAULT_CHARACTER_SETS.LOW;static DEFAULT_CVS_SIZE=[...ImageDisplay.RESOLUTIONS.MAX];static DEFAULT_MEDIA_SIZE=["92%","45%"];static DEFAULT_TEXT_SCALE=[2,1.25];static DEFAULT_MEDIA_ERROR_CALLBACK=(errorCode,media)=>console.warn("Error while loading media:",ImageDisplay.getErrorFromCode(errorCode),"("+media+")");static OUTPUT_FORMATS={NONE:0,MARKDOWN:1,HTML:2,UNICODE_MONOSPACE:3,NON_BREAKING_SPACES:4};static DEFAULT_OUTPUT_FORMAT=ImageToTextConverter.OUTPUT_FORMATS.NONE;static UNICODE_MONOSPACE_CONVERTIONS={a:"??",b:"??",c:"??",d:"??",e:"??",f:"??",g:"??",h:"??",i:"??",j:"??",k:"??",l:"??",m:"??",n:"??",o:"??",p:"??",q:"??",r:"??",s:"??",t:"??",u:"??",v:"??",w:"??",x:"??",y:"??",z:"??",A:"??",B:"??",C:"??",D:"??",E:"??",F:"??",G:"??",H:"??",I:"??",J:"??",K:"??",L:"??",M:"??",N:"??",O:"??",P:"??",Q:"??",R:"??",S:"??",T:"??",U:"??",V:"??",W:"??",X:"??",Y:"??",Z:"??",0:"??",1:"??",2:"??",3:"??",4:"??",5:"??",6:"??",7:"??",8:"??",9:"??"};#cachedRange=null;constructor(resultCB,sourceMedia,maxMediaInputSize=ImageToTextConverter.DEFAULT_CVS_SIZE,pxGroupingSize=5,charSet,maxRefreshRate=30){this._CVS=this.#createCVS(maxMediaInputSize,maxRefreshRate),this._resultCB=resultCB,this._pxGroupingSize=pxGroupingSize||5,this._charSet=charSet??ImageToTextConverter.DEFAULT_CHARACTER_SET,this.#updateCachedRange(),this._media=null,"string"!=typeof sourceMedia||sourceMedia.match(/\..{1,4}$/gi)?sourceMedia&&this.loadMedia(sourceMedia):this.createBigText(sourceMedia)}#createCVS(sizeOrCanvas,maxRefreshRate){let canvas=null;canvas=Array.isArray(sizeOrCanvas)?new OffscreenCanvas(sizeOrCanvas[0],sizeOrCanvas[1]):sizeOrCanvas instanceof Canvas?sizeOrCanvas.cvs:sizeOrCanvas instanceof HTMLCanvasElement||sizeOrCanvas instanceof OffscreenCanvas?sizeOrCanvas:new OffscreenCanvas(...ImageToTextConverter.DEFAULT_CVS_SIZE);return new Canvas(canvas,()=>{this._media?.initialized&&this._resultCB(this.#getText(this.#mapPixels(this._pxGroupingSize)))},maxRefreshRate,null,null,null,!0)}#updateCachedRange(){let range=[0],c_ll=this._charSet.length,rangeDivision=255/c_ll;for(let i=1;i<c_ll;i++)range[i]=range[i-1]+rangeDivision;this.#cachedRange=range}#mapPixels(pxGroupingSize=this._pxGroupingSize){let data,x,y,atY,atX,atI,CVS=this._CVS,mediaSize=this._media.trueSize,width=(mediaSize[0]|0)>CVS.width?CVS.width:mediaSize[0]|0,height=(mediaSize[0]|0)>CVS.height?CVS.height:mediaSize[1]|0,pxGroupingCount=pxGroupingSize**2*4,bigPxCountX=width/pxGroupingSize,bigPxCountY=height/pxGroupingSize,bigPixels=[],minDif=CDEUtils.getAcceptableDiff;try{data=CVS.ctx.getImageData(0,0,width,height).data}catch(e){const src=this._media.source.src;console.warn("Media unavailable due to cross-origin, width/height or loading issues."+(src?" \n("+src+")":"")+"\n\n'"+e.message.split(":")[1].trim()+"'"),data=[]}for(y=0;y<height;y+=pxGroupingSize)for(atY=y*pxGroupingSize,x=0;x<width;x+=pxGroupingSize){atX=x*pxGroupingSize;const overflow=width-(x+pxGroupingSize),bigPx=[],offsetX=minDif(atX/pxGroupingSize/width*bigPxCountX*pxGroupingSize*4,1e-6),offsetY=minDif(atY/pxGroupingSize/height*bigPxCountY*pxGroupingCount*bigPxCountX,1e-6);for(let i=0,adjust=0;i<pxGroupingCount;i+=4){i/4%pxGroupingSize||!i||(adjust=4*width*(i/pxGroupingCount*pxGroupingSize)-i),atI=offsetX+offsetY+i+adjust;const r=data[atI],g=data[atI+1],b=data[atI+2];bigPx.push(!data[atI+3]||null==r||null==g||null==b||i/4%pxGroupingSize>=pxGroupingSize+overflow?null:(r+g+b)/3)}let b_ll=bigPx.length,total=0,nullCount=0;for(let i=0;i<b_ll;i++){const pxAvg=bigPx[i];null==pxAvg?nullCount++:total+=pxAvg}bigPixels.push([y,total/(b_ll-nullCount)||0])}return bigPixels}#getText(pixelMappingResults){let range=this.#cachedRange,chars=this._charSet,c_ll=chars.length,p_ll=pixelMappingResults.length,textResults="",lastY=0;for(let i=0;i<p_ll;i++){let bigPx=pixelMappingResults[i],y=bigPx[0],avg=bigPx[1],atValue=-1,charIndex=0;for(let i=0;i<c_ll;i++){const newValue=range[i];newValue<=avg&&newValue>atValue&&(atValue=newValue,charIndex=i)}y!=lastY&&(textResults+="\n"),textResults+=chars[charIndex],lastY=y}return textResults}loadMedia(sourceMedia,size=[...ImageToTextConverter.DEFAULT_MEDIA_SIZE],croppingPositions=null,errorCB=ImageToTextConverter.DEFAULT_MEDIA_ERROR_CALLBACK,readyCB=null){this.clear(),this._media=new ImageDisplay(sourceMedia,[0,0],size,errorCB,img=>{img.isDynamic?this._CVS.start():(this._CVS.stop(),this.generate()),CDEUtils.isFunction(readyCB)&&readyCB(this)},null,null,!0),this._media.sourceCroppingPositions=croppingPositions,this._CVS.add(this._media)}createBigText(text,font=null,scale=[...ImageToTextConverter.DEFAULT_TEXT_SCALE],color=null,isFilled=!0,letterSpacing=8,wordSpacing=-20,fontVariantCaps=null,direction=null,fontStretch=null,textRendering=TextStyles.RENDERINGS.LEGIBLE){font??="normal 54px monospace",scale??=[...ImageToTextConverter.DEFAULT_TEXT_SCALE],this._CVS.stop(),this.clear(),this._media=new TextDisplay(text,[0,0],color,render=>render.textProfile1.update(font,letterSpacing,wordSpacing,fontVariantCaps,direction,fontStretch,null,TextStyles.ALIGNMENTS.START,TextStyles.BASELINES.TOP,textRendering),isFilled?Render.DRAW_METHODS.FILL:Render.DRAW_METHODS.STROKE,null,null,null,null,!0),this._CVS.add(this._media),this._media.scale=scale,this.generate()}createHTMLFileInput(id=null,onInputCB=null){const usesOldInput=id instanceof HTMLInputElement,input=usesOldInput?id:document.createElement("input");return input.type="file",id&&!usesOldInput&&(input.id=id),input.accept=ImageDisplay.getSupportedHTMLAcceptValue(),input.oninput=()=>{const file=input.files[0];if(CDEUtils.isFunction(onInputCB)&&onInputCB(file,this),file)if(ImageDisplay.isVideoFormatSupported(file))this.loadMedia(ImageDisplay.loadVideo(file));else if(ImageDisplay.isImageFormatSupported(file)){const fileReader=new FileReader;fileReader.onload=e=>this.loadMedia(ImageDisplay.loadImage(e.target.result,null,!0)),fileReader.readAsDataURL(file)}},input}static formatText(text,outputFormatingMethod=ImageToTextConverter.DEFAULT_OUTPUT_FORMAT){const outputFormats=ImageToTextConverter.OUTPUT_FORMATS;if(outputFormatingMethod==outputFormats.MARKDOWN)return"```\n"+text+"\n```";if(outputFormatingMethod==outputFormats.HTML)return`<div style="white-space: pre !important;font-family: monospace !important;font-size: 16px;letter-spacing: 0px;line-height: 18px;">${text}</div>`;if(outputFormatingMethod==outputFormats.NON_BREAKING_SPACES)return text.replaceAll(" "," ");if(outputFormatingMethod==outputFormats.UNICODE_MONOSPACE){const unicodeMonospaceConvertions=ImageToTextConverter.UNICODE_MONOSPACE_CONVERTIONS;return text.replaceAll(/./g,char=>unicodeMonospaceConvertions[char]||char)}return text}generate(){this._CVS.drawSingleFrame()}clear(){this._CVS.removeAllObjects(),this._CVS.clear()}updatePxGroupingSize(pxGroupingSize=5){return this._pxGroupingSize=pxGroupingSize,this.generate(),this._pxGroupingSize}updateCharSet(charSet=ImageToTextConverter.DEFAULT_CHARACTER_SETS[CDEUtils.random(0,ImageToTextConverter.DEFAULT_CHARACTER_SETS.length)]){return this.charSet=charSet,this.generate(),this.charSet}get CVS(){return this._CVS}get cvs(){return this._CVS.cvs}get size(){return this._CVS.size}get charSet(){return this._charSet}get media(){return this._media}get pxGroupingSize(){return this._pxGroupingSize}get resultCB(){return this._resultCB}get maxRefreshRate(){return this._CVS.fpsLimit}set size(size){this._CVS.width=size[0],this._CVS.height=size[1]}set charSet(charSet){this._charSet="string"==typeof charSet?[...charSet]:charSet,this.#updateCachedRange()}set pxGroupingSize(pxGroupingSize){this._pxGroupingSize=pxGroupingSize}set maxRefreshRate(maxRefreshRate){this._CVS.fpsLimit=maxRefreshRate}set resultCB(resultCB){this._resultCB=resultCB}}
